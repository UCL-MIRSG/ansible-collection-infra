---
# mirsg.postgresql - setting up the database
postgresql_database:
  database_name: "{{ omero_db.postgresql_database }}"
  user_name: "{{ omero_db.postgresql_user }}"
  user_password: "{{ omero_db.postgresql_password }}"

# mirsg.postgresql - connections and authentication
postgresql_connection:
  host: "{{ omero_db.host }}"
  port: "{{ omero_db.port }}"
  client_ip: "{{ omero_server.ip }}"
  client_certificate_filename: "/var/lib/pgsql/certs/root.crt" # required if using SSL, where to copy the client certificate to on the server
  listen_addresses: "{{ omero_db.listen_addresses | default('localhost, ' + omero_db.host) | quote }}"
  subnet_mask: "{{ omero_server.subnet_mask | default('255.255.255.255') }}"

# mirsg.postgresql - external storage
postgresql_storage:
  storage_directory: "{{ omero_db.storage_dir }}"
  data_directory: "{{ omero_db.data_dir }}" # symlink to data_directory

# mirsg.postgresql - backup
postgresql_backup:
  directory: "{{ omero_db.backups_dir }}"
  script: "{{ postgresql.base_directory }}/run_db_backup.sh" # script to run cron backup job

# mirsg.ssl_certificates for the postgresql server
postgresql_ssl_certificate:
  owner: "{{ postgresql.owner }}"
  group: "{{ postgresql.group }}"
  certificate_directory: "{{ postgresql.base_directory }}/certs"
  privatekey_filename: "{{ postgresql.base_directory }}/certs/server.key"
  use_pk8: false
  csr_filename: "{{ postgresql.base_directory }}/certs/server.csr"
  csr_common_name: "{{ omero_db.host }}"
  certificate_filename: "{{ postgresql.base_directory }}/certs/server.crt"
  provider: "selfsigned"
  cache_filename: "{{ database_server_certificate_cache_filename }}" # where to store the server certificate in cache

# mirsg.firewalld
firewalld_rich_rules:
  - zone: "internal"
    rule: "family=ipv4 source address={{ omero_server.subnet | default(omero_server.ip + '/32') }} port protocol=tcp port={{ omero_db.port }} accept"

# mirsg.infrastructure.firewalld
firewalld_internal_zone_sources:
  - "{{ omero_server.subnet | default(omero_server.ip + '/32') }}"

firewalld_internal_zone_open_services:
  - "postgresql"
