---
name: links

on:
  push:
    branches:
      - main
      - renovate/**
  pull_request:

jobs:
  links:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Check links
        uses: UCL-MIRSG/.github/actions/links@feed2f417cdc1508d1a9eb3cb6e99c84f2a4b154 # v0
        with:
          app-id: ${{ secrets.LINK_APP_ID }}
          app-pem: ${{ secrets.LINK_APP_PEM }}

      - name: Generate token
        if: always()
        id: generate-token
        uses: actions/create-github-app-token@c1a285145b9d317df6ced56c09f525b5c2b6f755 # v1
        with:
          app-id: ${{ secrets.LINK_APP_ID }}
          private-key: ${{ secrets.LINK_APP_PEM }}

      - name: Test access
        if: always()
        run: |-
            curl -H "Authorization: Bearer ${{ steps.generate-token.outputs.token }}" \
            https://api.github.com/repos/UCL-MIRSG/UCLMedicalImagingEnv/contents/environments/cs-production/xnat/group_vars/ucl_test
