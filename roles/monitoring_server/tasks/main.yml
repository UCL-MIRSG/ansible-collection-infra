---
- name: Find limited web servers in monitoring_server_client_hostnames list
  ansible.builtin.set_fact:
    # loop through the list and concatenate the result
    # the default([]) means use the empty list if list doesn't exist
    # add to this the ansible group corresponding to the given item
    # then perform the intersection with the monitoring_service and web group
    # then get the URL from the host
    # and prepend https:// to the start of each entry
    monitoring_server_web_clients: >
      {{
      group_names |
      intersect(groups['web']) |
      map('regex_replace', '^', 'https://')
      }}
  loop:
    - "{{ monitoring_server_client_hostnames }}"
  when: monitoring_server_client_hostnames is defined

- name: Add monitoring_server group
  ansible.builtin.group:
    name: "{{ monitoring_server_group }}"
    gid: "{{ monitoring_server_gid }}"

- name: Add monitoring_server user
  ansible.builtin.user:
    name: "{{ monitoring_server_owner }}"
    group: "{{ monitoring_server_group }}"
    uid: "{{ monitoring_server_uid }}"
    create_home: false
    system: true

- name: Install Docker SDK for Python
  ansible.builtin.pip:
    name:
      - docker
  notify:
    - Restart docker

- name: Ensure docker service restarts after Docker SDK is installed
  ansible.builtin.meta: flush_handlers

- name: Create a network
  community.docker.docker_network:
    name: monitor-net

- name: Install and configure Nginx container
  ansible.builtin.include_tasks: install_nginx_container.yml

- name: Install and configure Prometheus container
  ansible.builtin.include_tasks: install_prometheus_container.yml

- name: Install and configure Blackbox Exporter container
  ansible.builtin.include_tasks: install_blackbox_exporter_container.yml

- name: Install and configure cadvisor container
  ansible.builtin.include_tasks: install_cadvisor_container.yml

- name: Install and configure Grafana container
  ansible.builtin.include_tasks: install_grafana_container.yml

- name: Install and configure alertmanager container
  ansible.builtin.include_tasks: install_alertmanager_container.yml
