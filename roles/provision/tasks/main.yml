---
- name: Check mounts are available
  tags: restart
  ansible.builtin.include_tasks: check_mounts.yml
  vars:
    mount_point: "{{ item }}"
  loop: "{{ provision_mount_points }}"

- name: Set up for RedHat 7
  ansible.builtin.include_tasks: RedHat7.yml
  when: ansible_facts['distribution_major_version'] is version('7')

- name: Set up for RedHat > 7
  ansible.builtin.include_tasks: RedHat.yml
  when: ansible_facts['distribution_major_version'] is not version('7')

- name: Upgrade all packages # noqa: package-latest
  ansible.builtin.yum:
    name: "*"
    state: latest

- name: Clean DNF cache
  ansible.builtin.dnf:
    name: "*"
    autoremove: true
  when: ansible_facts['distribution_major_version'] | int >= 9

- name: Attempt to update all packages to latest version
  ansible.builtin.yum:
    name: "*"
  when: ansible_facts['distribution_major_version'] | int >= 9

- name: Reinstall python3 to resolve dependency issues
  ansible.builtin.yum:
    name: python3
  when: ansible_facts['distribution_major_version'] | int >= 9

- name:
    Install specific version of python3 and python-unversioned-command if needed
  ansible.builtin.yum:
    name:
      - python3-3.9.18-3.el9_4.5
      - python-unversioned-command-3.9.18-3.el9_4.5
    state: present
  when: ansible_facts['distribution_major_version'] | int >= 9

  tags:
    - molecule-idempotence-notest

- name: Ensure epel is installed
  become: true
  ansible.builtin.yum:
    name: epel-release
    state: installed
